# Dockerfile generated by tp::dockerize { '<%= @app %>': }
FROM <%= @real_from %>
<% if @maintainer -%>
MAINTAINER <%= @maintainer %>
<% end -%>

<% if @os == 'debian' or @os == 'ubuntu' -%>
<% if @settings['repo_url'] -%>
RUN echo "deb <%= @settings['repo_url'] -%> <%= @settings['apt_repos'] %> <%= @settings['apt_release'] %>" > /etc/apt/sources.list.d/<%= @app %>.list
<% if @settings['apt_key_server'] -%>
RUN apt-key add --keyserver <%= @settings['apt_key_server'] %> --recv-key <%= @settings['key'] %>
<% end -%>
<% end -%>
RUN apt-get update && \
    apt-get install -y --no-install-recommends <%= @settings['package_name'] %> && \
<% if @command_mode == 'supervisor' -%>
    apt-get install -y --no-install-recommends <%= @settings_supervisor['package_name'] %> && \
<% end -%>
    rm -rf /var/lib/apt/lists/*
<% end -%>
<% if @os == 'redhat' or @os == 'centos' -%>
<% if @settings['repo_url'] -%>
RUN echo "[<%= @app %>]\nname=<%= @app %> repository\nbaseurl=<%= @settings['repo_url'] -%> > /etc/yum.repos.d/<%= @app %>.repo
<% end -%>
RUN yum install -y epel-release
RUN yum install -y <%= @settings['package_name'] %> <% if @command_mode == 'supervisor' -%><%= @settings_supervisor['package_name'] %><% end -%> && yum clean all
<% end -%>
<% if @os == 'alpine' -%>
RUN echo "http://dl-3.alpinelinux.org/alpine/edge/testing\nhttp://dl-3.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
RUN apk --no-cache add <%= @settings['package_name'] %> <% if @command_mode == 'supervisor' -%><%= @settings_supervisor['package_name'] %><% end %>
<% end -%>
<% if @command_mode == 'supervisor' -%>
<% if @settings_supervisor['conf_dir_path'].to_s.empty?
destfile = @settings_supervisor['config_file_path']
else
destfile = @settings_supervisor['conf_dir_path'] + "/" + @app + ".conf"
end -%>
RUN echo "[supervisord]\nnodaemon=true\n\n[program:<%= @settings['process_name'] %>]\ncommand=<%= @settings['process_name'] %> <% if @settings['process_extra_name'] -%><%= @settings['process_extra_name'] -%><% end -%> <% if @settings['process_args'] -%><%= @settings['process_args'] %><% end -%> <% if @settings['nodaemon_args'] -%><%= @settings['nodaemon_args'] %><% end -%>" >> <%= destfile %>
<% end -%>

<% if @settings['tcp_port'] -%>
EXPOSE <%= @settings['tcp_port'] %>
<% end -%>
<% if (@settings['data_dir_path'] and @mount_data_dir) or (@settings['log_dir_path'] and @mount_log_dir) -%>
VOLUME <% if @settings['data_dir_path'] and @mount_data_dir -%><%= @settings['data_dir_path'] %><% end -%> <% if @settings['log_dir_path'] and @mount_log_dir -%><%= @settings['log_dir_path'] %> <% end -%>
<% end -%>

<% if @command_mode == 'command' %>
ENTRYPOINT [ "<%= @settings['process_name'] %>"<% if @settings['process_extra_name'] -%> , "<%= @settings['process_extra_name'] -%>"<% end -%> <% if @settings['nodaemon_args'] -%> <% commb = '' %> , "<% @settings['nodaemon_args'].split.each do |nd| %><%= commb %>"<%= nd %>"<% commb = ',' %><% end -%><% end -%> ]
<% if @settings['process_args'] -%>
CMD [ <% comma = '' %><% @settings['process_args'].split.each do |ar| %><%= comma %>"<%= ar %>"<% comma = ',' %><% end -%> ]
<% end -%>
<% end -%>
<% if @command_mode == 'supervisor' %>
CMD [ "/usr/bin/<%= @settings_supervisor['process_name'] -%>" , "-c" , "<%= @settings_supervisor['config_file_path'] -%>" ]
<% end -%>
